{% extends "base.html" %}

{% block content %}
<section class="section">
  <div class="section-head">
    <h1>Матчи</h1>
    <div class="dashboard-actions">
      <a href="{% url 'dashboard:article_list' %}" class="button button--secondary">Статьи</a>
      <a href="{% url 'dashboard:team_list' %}" class="button button--secondary">Команды</a>
      <a href="{% url 'dashboard:tournament_list' %}" class="button button--secondary">Турниры</a>
      {% if can_manage_users %}
        <a href="{% url 'dashboard:user_list' %}" class="button button--secondary">Пользователи</a>
      {% endif %}
      <a href="{% url 'dashboard:match_create' %}" class="button">Создать матч</a>
    </div>
  </div>

  {% include "includes/dashboard_search_bar.html" with action_url=request.path query_value=query placeholder="Поиск по названию / городу / дисциплине" aria_label="Поиск матча" input_aria_label="Поиск матча" reset_url=reset_url %}

  <form method="get" class="dashboard-actions" style="margin-bottom: 0.75rem;">
    {% if query %}<input type="hidden" name="q" value="{{ query }}">{% endif %}
    <label class="filter-label" for="category">Тип</label>
    <select class="filter-select" id="category" name="category">
      <option value="">Все</option>
      {% for value, label in category_choices %}
        <option value="{{ value }}" {% if current_filters.category == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
    <label class="filter-label" for="discipline">Дисциплина</label>
    <select class="filter-select" id="discipline" name="discipline">
      <option value="">Все</option>
      {% for value, label in discipline_choices %}
        <option value="{{ value }}" {% if current_filters.discipline == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
    <label class="filter-label" for="status">Статус</label>
    <select class="filter-select" id="status" name="status">
      <option value="">Все</option>
      {% for value, label in status_choices %}
        <option value="{{ value }}" {% if current_filters.status == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
    <label class="filter-label" for="example">Режим</label>
    <select class="filter-select" id="example" name="example">
      <option value="">Все</option>
      <option value="real" {% if current_filters.example == "real" %}selected{% endif %}>Реальные</option>
      <option value="only" {% if current_filters.example == "only" %}selected{% endif %}>Примеры</option>
    </select>
    <label class="filter-label" for="tournament">Турнир</label>
    <select class="filter-select" id="tournament" name="tournament">
      <option value="">Все</option>
      {% for tournament in tournament_choices %}
        <option value="{{ tournament.id }}" {% if current_filters.tournament == tournament.id|stringformat:"s" %}selected{% endif %}>{{ tournament.name }}</option>
      {% endfor %}
    </select>
    <label class="filter-label" for="date_from">С даты</label>
    <input class="filter-select" id="date_from" name="date_from" type="date" value="{{ current_filters.date_from }}">
    <label class="filter-label" for="date_to">По дату</label>
    <input class="filter-select" id="date_to" name="date_to" type="date" value="{{ current_filters.date_to }}">
    <button type="submit" class="button button--secondary button--small dash-btn">Фильтр</button>
    <a href="{{ reset_url }}" class="button button--small dash-btn">Сбросить</a>
  </form>

  {% if page_obj.object_list %}
    <div class="dashboard-table-wrap">
      <table class="dashboard-table">
        <thead>
          <tr>
            <th>Матч</th>
            <th>Тип</th>
            <th>Дисциплина</th>
            <th>Турнир</th>
            <th>Статус</th>
            <th>Дата</th>
            <th>Счёт</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for match in page_obj.object_list %}
            <tr>
              <td>
                <a href="{% url 'matches:match_detail' match.pk %}" target="_blank" rel="noopener">{{ match.participants_display }}</a>
                {% if match.is_example %}<span class="news-pill">Пример</span>{% endif %}
              </td>
              <td>{{ match.get_kind_display }}</td>
              <td>{{ match.get_discipline_display|default:"-" }}</td>
              <td>{{ match.tournament.name|default:"-" }}</td>
              <td>{{ match.get_status_display }}</td>
              <td>{{ match.start_datetime|date:"d.m.Y H:i" }}</td>
              <td>{{ match.score_display|default:"-" }}</td>
              <td class="dashboard-actions dash-row-actions">
                <a href="{% url 'dashboard:match_edit' match.pk %}" class="button button--small dash-btn dash-btn--row dash-btn--edit">Редактировать</a>
                <a href="{% url 'dashboard:match_delete' match.pk %}" class="button button--small button--danger dash-btn dash-btn--row dash-btn--delete">Удалить</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if page_obj.paginator.num_pages > 1 %}
      <nav class="pagination" aria-label="Пагинация матчей dashboard">
        {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}{% if pagination_query %}&{{ pagination_query }}{% endif %}" class="pagination-link">Назад</a>
        {% endif %}
        <span class="pagination-current">Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}{% if pagination_query %}&{{ pagination_query }}{% endif %}" class="pagination-link">Вперед</a>
        {% endif %}
      </nav>
    {% endif %}
  {% else %}
    <p class="muted">Матчи не найдены.</p>
  {% endif %}
</section>
{% endblock %}
