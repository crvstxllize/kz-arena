{% extends "base.html" %}
{% load static %}

{% block content %}
<section class="section auth-section dashboard-form">
  <div class="section-head">
    <h1>{% if article %}Редактирование статьи{% else %}Создание статьи{% endif %}</h1>
    <a href="{% url 'dashboard:article_list' %}" class="button button--secondary">К списку</a>
  </div>

  <form method="post" enctype="multipart/form-data" class="auth-form dashboard-article-form" novalidate>
    {% csrf_token %}

    {% for field in form %}
      <div class="form-row{% if field.name == 'categories' or field.name == 'tags' %} checklist-row{% endif %}{% if field.name == 'cover' %} cover-row{% endif %}">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {% if field.name == 'cover' and article and article.cover %}
          <div class="dashboard-cover-preview">
            <img src="{{ article.cover.url }}" alt="Текущая обложка статьи">
            <div>
              <p class="dashboard-cover-preview__title">Текущая обложка</p>
              <p class="muted">{{ article.cover.name }}</p>
            </div>
          </div>
        {% endif %}

        {% if field.name == 'categories' or field.name == 'tags' %}
          <div class="dash-checklist">
            {{ field }}
          </div>
        {% else %}
          {{ field }}
        {% endif %}
        {% if field.help_text %}<small class="help-text">{{ field.help_text }}</small>{% endif %}
        {% for error in field.errors %}<p class="field-error">{{ error }}</p>{% endfor %}
      </div>
    {% endfor %}

    {% for error in form.non_field_errors %}<p class="field-error">{{ error }}</p>{% endfor %}

    <div class="form-actions">
      <button type="submit" class="button">Сохранить</button>
    </div>
  </form>
</section>

{% if article %}
<section class="section dashboard-assets">
  <h2>Дополнительные изображения</h2>
  <p class="muted">Добавляйте свои изображения к статье: они появятся в блоке дополнительных материалов.</p>

  {% if asset_items %}
    <div class="asset-grid">
      {% for asset in asset_items %}
      <article class="asset-card">
        <img src="{{ asset.file.url }}" alt="{{ asset.caption|default:'Изображение статьи' }}" class="asset-card__image">
        <p class="muted">{{ asset.caption|default:"Без подписи" }}</p>
      </article>
      {% endfor %}
    </div>
  {% else %}
    <p class="muted">Дополнительных изображений пока нет.</p>
  {% endif %}

  <form method="post" enctype="multipart/form-data" class="auth-form dashboard-asset-form" novalidate>
    {% csrf_token %}
    <input type="hidden" name="add_asset" value="1">

    {% for field in asset_form %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% for error in field.errors %}<p class="field-error">{{ error }}</p>{% endfor %}
      </div>
    {% endfor %}

    <button type="submit" class="button">Добавить изображение</button>
  </form>
</section>
{% endif %}
{% endblock %}
